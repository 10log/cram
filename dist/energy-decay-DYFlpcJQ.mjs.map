{"version":3,"file":"energy-decay-DYFlpcJQ.mjs","sources":["../src/compute/energy-decay.ts"],"sourcesContent":["// https://dsp.stackexchange.com/questions/17121/calculation-of-reverberation-time-rt60-from-the-impulse-response\r\n\r\nimport FileSaver from \"file-saver\";\r\nimport { v4 as uuid } from 'uuid';\r\nimport { audioEngine } from \"../audio-engine/audio-engine\";\r\nimport { emit, on } from \"../messenger\";\r\nimport { addSolver, setSolverProperty, useSolver } from \"../store/solver-store\";\r\nimport Solver, { SolverParams } from \"./solver\";\r\n\r\n// import audio\r\n\r\n// filter response at appropriate octave band (butterworth 3rd order)\r\n\r\n// hilbert transform of signal\r\n\r\n// convert to decibel scale\r\n\r\n// schroeder integration \r\n\r\n// linear interpolation of decay curve to obtain T20, T30, etc...\r\n\r\nexport interface EnergyDecayProps extends SolverParams{\r\n    //uuid?: string;\r\n    // containers: KVP<Container>; \r\n}\r\n\r\nexport type EnergyDecaySaveObject = {\r\n    uuid: string;\r\n    name: string;\r\n    kind: \"energydecay\";\r\n    autoCalculate: boolean;\r\n}\r\n\r\nconst defaults = {\r\n    name: \"Energy Decay\",\r\n};\r\n\r\nconst AudioContext = (window.AudioContext);\r\n\r\nconst filterFreqs = [125,250,500,1000,2000,4000,8000];\r\n\r\nclass EnergyDecay extends Solver{ \r\n    public uuid; \r\n    public broadbandIRData: Float32Array; \r\n    public broadbandIRSampleRate: number; \r\n    public broadbandIRSource: any; \r\n\r\n    public source: AudioBufferSourceNode | null = null;\r\n\r\n    public filteredData: Float32Array[]; \r\n    public filteredEnergyDecayData: Float32Array[]; \r\n\r\n    public impulseResponsePlaying: boolean; \r\n\r\n    public filterTest: any; \r\n\r\n    public T15: number[]; \r\n    public T20: number[];\r\n    public T30: number[]; \r\n\r\n    constructor(props: EnergyDecayProps = defaults){\r\n        super(props);\r\n        this.kind = \"energydecay\";\r\n        this.name = props.name || defaults.name;\r\n\r\n        this.broadbandIRData = new Float32Array(); \r\n        this.broadbandIRSampleRate = 0; \r\n\r\n        this.uuid = uuid(); \r\n\r\n        this.filteredData = []; \r\n        this.filteredEnergyDecayData = [];\r\n\r\n        this.impulseResponsePlaying = false; \r\n\r\n        this.filterTest = null;\r\n\r\n        this.T15 = [];\r\n        this.T20 = [];\r\n        this.T30 = []; \r\n    }\r\n\r\n    calculateAcParams(){\r\n        if(this.filteredData.length === 0){\r\n            console.error(\"No IR Data Loaded\");\r\n        }\r\n\r\n        this.calculateOctavebandBackwardsIntegration();\r\n\r\n        for(let f = 0; f<filterFreqs.length; f++){\r\n            this.T15[f] = calculateRTFromDecay(this.filteredEnergyDecayData[f],15,this.broadbandIRSampleRate);\r\n            this.T20[f] = calculateRTFromDecay(this.filteredEnergyDecayData[f],20,this.broadbandIRSampleRate);\r\n            this.T30[f] = calculateRTFromDecay(this.filteredEnergyDecayData[f],30,this.broadbandIRSampleRate);\r\n        }\r\n\r\n        console.log(filterFreqs); \r\n        console.log(\"T10 Values: \");\r\n        console.log(this.T15); \r\n        console.log(\"T20 Values: \");\r\n        console.log(this.T20); \r\n        console.log(\"T30 Values: \");\r\n        console.log(this.T30); \r\n\r\n        this.downloadResultsAsCSV(); \r\n\r\n    }\r\n\r\n    calculateOctavebandBackwardsIntegration(){\r\n        for(let f = 0; f<filterFreqs.length; f++){\r\n            this.filteredEnergyDecayData[f] = schroederBackwardsIntegration(this.filteredData[f]); \r\n        }\r\n    }\r\n\r\n    downloadResultsAsCSV(){\r\n\r\n        let precision = 4;\r\n        let freqlabel = \"Octave Band (Hz),\"\r\n        let t15label = \"T15,\";\r\n        let t20label = \"T20,\"; \r\n        let t30label = \"T30,\"; \r\n    \r\n        let CSV = [freqlabel.concat((filterFreqs).toString()),\r\n          t15label.concat((this.T15).map((n)=>n.toFixed(precision)).toString()),\r\n          t20label.concat((this.T20).map((n)=>n.toFixed(precision)).toString()),\r\n          t30label.concat((this.T30).map((n)=>n.toFixed(precision)).toString()),\r\n        ].join('\\n');\r\n    \r\n        var csvFile = new Blob([CSV], {type: 'text/csv'});\r\n        FileSaver.saveAs(csvFile, `energy-decay-${this.uuid}.csv`);\r\n      }\r\n\r\n    play(source: AudioBufferSourceNode){\r\n        if (audioEngine.context.state === 'suspended') {\r\n            audioEngine.context.resume();\r\n          }\r\n\r\n        source.connect(audioEngine.context.destination); \r\n        source.start();\r\n\r\n        emit(\"ENERGYDECAY_SET_PROPERTY\", { uuid: this.uuid, property: \"impulseResponsePlaying\", value: true });\r\n        source.onended = () => {\r\n            source.stop();\r\n            source.disconnect(audioEngine.context.destination);\r\n            emit(\"ENERGYDECAY_SET_PROPERTY\", { uuid: this.uuid, property: \"impulseResponsePlaying\", value: false });\r\n        }\r\n    }\r\n\r\n    set broadbandIR(f: ArrayBuffer){\r\n        let self = this; \r\n        audioEngine.context.decodeAudioData(f, async function(buffer) {\r\n\r\n            let decodeddata = trimIR(buffer.getChannelData(0)); \r\n\r\n            self.broadbandIRSource = audioEngine.createBufferSource(decodeddata);\r\n            self.broadbandIRData = decodeddata;\r\n            self.broadbandIRSampleRate = buffer.sampleRate; \r\n\r\n            self.filterTest = audioEngine.createFilteredSource(decodeddata,8000,1.414,1); \r\n\r\n            let broadbandarray: Float32Array[] = []; \r\n            for(let f = 0; f<filterFreqs.length; f++){\r\n                broadbandarray[f] = decodeddata; \r\n            }\r\n\r\n            for(let f = 0; f<filterFreqs.length; f++){\r\n                const offlineContext = audioEngine.createOfflineContext(1, decodeddata.length, buffer.sampleRate);\r\n                const filteredsource = audioEngine.createFilteredSource(decodeddata, filterFreqs[f], 1.414,1,offlineContext);\r\n                filteredsource.gain.connect(offlineContext.destination);\r\n                filteredsource.source.start(); \r\n\r\n                let data = await audioEngine.renderContextAsync(offlineContext);\r\n                self.filteredData.push(data.getChannelData(0)); \r\n            }\r\n\r\n        }) \r\n    }\r\n}\r\n\r\nfunction calculateRTFromDecay(decay: Float32Array,decayLength: number,sampleRate:number): number{\r\n    const n1: number = -5; // start at -5 dB \r\n    const n2: number = n1-decayLength; // ex. if T30, -5 to -35 dB \r\n\r\n    let n1_idx = indexOfMin(abs(subFromArray(decay,n1))); \r\n    let n2_idx = indexOfMin(abs(subFromArray(decay,n2))); \r\n\r\n    let numSamples = Math.abs(n2_idx-n1_idx); \r\n\r\n    let decay_time = numSamples/sampleRate; \r\n    let reverb_time = decay_time*(60/decayLength); \r\n\r\n    return reverb_time; \r\n}\r\n\r\nfunction schroederBackwardsIntegration(data: Float32Array){\r\n\r\n    const td = data.length; // upper integration limit \r\n\r\n    let data_reversed: Float32Array = data.reverse(); \r\n\r\n    let data_reversed_sq: Float32Array = data_reversed.map((x)=>Math.pow(x,2)); \r\n\r\n    let data_reversed_sq_cumsum: Float32Array = cumsum(data_reversed_sq); \r\n\r\n    let data_sq: Float32Array = data.map((x)=>Math.pow(x,2)); \r\n    let data_sq_sum: number = sum(data_sq);\r\n    \r\n    let data_reversed_sq_cumsum_div_sum: Float32Array = data_reversed_sq_cumsum.map((x)=>(x/data_sq_sum)); \r\n\r\n    let bi_result: Float32Array = data_reversed_sq_cumsum_div_sum.map((x)=>{\r\n        if(x!==0){\r\n            return 10*Math.log10(x);\r\n        }else{\r\n            return 0;\r\n        }\r\n    }); \r\n    return bi_result; \r\n}\r\n\r\nfunction indexOfMin(data: Float32Array): number{\r\n    let min_index = 0;\r\n    let min = data[min_index]; \r\n\r\n    for(let i = 0; i<data.length; i++){\r\n        if (min > data[i]) {\r\n            min = data[i]; \r\n            min_index = i; \r\n        }\r\n    }\r\n    return min_index; \r\n}\r\n\r\nfunction sum(data: Float32Array): number{\r\n    let sum: number = data.reduce(function(acc,currentValue) {\r\n        return acc + currentValue; \r\n    }, 0); \r\n    return sum; \r\n}\r\n\r\nfunction cumsum(data: Float32Array): Float32Array{\r\n    const cumulativeSum = ((sum: number) => (value: number) => sum += value)(0);\r\n    let cumsum_array = data.map(cumulativeSum);\r\n\r\n    return cumsum_array;\r\n}\r\n\r\nfunction abs(data: Float32Array): Float32Array{\r\n    let absarray = data.map((x)=>Math.abs(x));\r\n    return absarray; \r\n}\r\n\r\nfunction subFromArray(data: Float32Array, sub: number): Float32Array{\r\n    let subarray = data.map((x)=>(x-sub)); \r\n    return subarray; \r\n}\r\n\r\nfunction trimIR(ir: Float32Array): Float32Array {\r\n    let tolerance = 1e-6; \r\n    let startSample = 0; \r\n    let endSample = ir.length; \r\n\r\n    let sindex = 0; \r\n    while(Math.abs(ir[sindex]) < tolerance){\r\n        startSample = sindex; \r\n        sindex++; \r\n    }\r\n\r\n    sindex = ir.length\r\n    while(Math.abs(ir[sindex]) < tolerance){\r\n        endSample = sindex; \r\n        sindex--; \r\n    }\r\n\r\n    return ir.slice(startSample,endSample); \r\n}\r\n\r\nexport default EnergyDecay\r\n\r\n// this allows for nice type checking with 'on' and 'emit' from messenger\r\ndeclare global {\r\n    interface EventTypes {\r\n      ADD_ENERGYDECAY: EnergyDecay | undefined,\r\n      ENERGYDECAY_SET_PROPERTY: {\r\n        uuid: string;\r\n        property: keyof EnergyDecay;\r\n        value: EnergyDecay[EventTypes[\"ENERGYDECAY_SET_PROPERTY\"][\"property\"]]; \r\n      }\r\n      LOAD_IR_TO_ENERGYDECAY: {\r\n          uuid: string;\r\n          f: File; \r\n      }\r\n      CALCULATE_AC_PARAMS: string; \r\n    }\r\n}\r\n\r\non(\"ADD_ENERGYDECAY\", addSolver(EnergyDecay))\r\non(\"ENERGYDECAY_SET_PROPERTY\", setSolverProperty); \r\non(\"CALCULATE_AC_PARAMS\", (uuid: string) => void (useSolver.getState().solvers[uuid] as EnergyDecay).calculateAcParams());\r\n\r\n"],"names":["defaults","filterFreqs","EnergyDecay","Solver","props","uuid","f","calculateRTFromDecay","schroederBackwardsIntegration","precision","CSV","n","csvFile","FileSaver","source","audioEngine","emit","self","buffer","decodeddata","trimIR","offlineContext","filteredsource","data","decay","decayLength","sampleRate","n2","n1_idx","indexOfMin","abs","subFromArray","n2_idx","data_reversed_sq","x","data_reversed_sq_cumsum","cumsum","data_sq","data_sq_sum","sum","min_index","min","i","acc","currentValue","cumulativeSum","value","sub","ir","tolerance","startSample","endSample","sindex","on","addSolver","setSolverProperty","useSolver"],"mappings":"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"}