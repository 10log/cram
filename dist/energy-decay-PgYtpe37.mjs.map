{"version":3,"file":"energy-decay-PgYtpe37.mjs","sources":["../src/compute/schroeder.ts","../src/compute/trim-ir.ts","../src/compute/energy-decay.ts"],"sourcesContent":["/**\n * Schroeder backwards integration for energy decay curves.\n *\n * Computes the energy decay curve from an impulse response by\n * reverse-cumulative-summing the squared signal and normalizing\n * by the total energy, then converting to decibels.\n *\n * Reference: Schroeder, M.R. (1965). \"New Method of Measuring\n * Reverberation Time.\" JASA 37(3), 409â€“412.\n */\n\nfunction sum(data: Float32Array): number {\n  return data.reduce((acc, v) => acc + v, 0);\n}\n\nfunction cumsum(data: Float32Array): Float32Array {\n  const cumulativeSum = ((s: number) => (value: number) => s += value)(0);\n  return data.map(cumulativeSum);\n}\n\nexport function schroederBackwardsIntegration(data: Float32Array): Float32Array {\n  const data_reversed = new Float32Array(data).reverse();\n  const data_reversed_sq = data_reversed.map((x) => x ** 2);\n  const data_reversed_sq_cumsum = cumsum(data_reversed_sq);\n\n  const data_sq = data.map((x) => x ** 2);\n  const data_sq_sum = sum(data_sq);\n\n  const normalized = data_reversed_sq_cumsum.map((x) => x / data_sq_sum);\n\n  return normalized.map((x) => (x !== 0 ? 10 * Math.log10(x) : 0));\n}\n","/**\n * Trim leading and trailing silence from an impulse response.\n *\n * Samples with absolute value below `tolerance` are considered silence.\n * The trimmed result includes one silent sample before the onset\n * (due to how startSample is tracked).\n */\nexport function trimIR(ir: Float32Array): Float32Array {\n  const tolerance = 1e-6;\n  let startSample = 0;\n  let endSample = ir.length;\n\n  let sindex = 0;\n  while (sindex < ir.length && Math.abs(ir[sindex]) < tolerance) {\n    startSample = sindex;\n    sindex++;\n  }\n\n  sindex = ir.length - 1;\n  while (sindex >= 0 && Math.abs(ir[sindex]) < tolerance) {\n    endSample = sindex;\n    sindex--;\n  }\n\n  return ir.slice(startSample, endSample);\n}\n","// https://dsp.stackexchange.com/questions/17121/calculation-of-reverberation-time-rt60-from-the-impulse-response\n\nimport FileSaver from \"file-saver\";\nimport { v4 as uuid } from 'uuid';\nimport { audioEngine } from \"../audio-engine/audio-engine\";\nimport { emit, on } from \"../messenger\";\nimport { addSolver, setSolverProperty, useSolver } from \"../store/solver-store\";\nimport Solver, { SolverParams } from \"./solver\";\nimport { schroederBackwardsIntegration } from \"./schroeder\";\nimport { trimIR } from \"./trim-ir\";\n\n// import audio\n\n// filter response at appropriate octave band (butterworth 3rd order)\n\n// hilbert transform of signal\n\n// convert to decibel scale\n\n// schroeder integration \n\n// linear interpolation of decay curve to obtain T20, T30, etc...\n\nexport interface EnergyDecayProps extends SolverParams{\n    //uuid?: string;\n    // containers: KVP<Container>; \n}\n\nexport type EnergyDecaySaveObject = {\n    uuid: string;\n    name: string;\n    kind: \"energydecay\";\n    autoCalculate: boolean;\n}\n\nconst defaults = {\n    name: \"Energy Decay\",\n};\n\nconst AudioContext = (window.AudioContext);\n\nconst filterFreqs = [125,250,500,1000,2000,4000,8000];\n\nclass EnergyDecay extends Solver{ \n    public uuid; \n    public broadbandIRData: Float32Array; \n    public broadbandIRSampleRate: number; \n    public broadbandIRSource: any; \n\n    public source: AudioBufferSourceNode | null = null;\n\n    public filteredData: Float32Array[]; \n    public filteredEnergyDecayData: Float32Array[]; \n\n    public impulseResponsePlaying: boolean; \n\n    public filterTest: any; \n\n    public T15: number[]; \n    public T20: number[];\n    public T30: number[]; \n\n    constructor(props: EnergyDecayProps = defaults){\n        super(props);\n        this.kind = \"energydecay\";\n        this.name = props.name || defaults.name;\n\n        this.broadbandIRData = new Float32Array(); \n        this.broadbandIRSampleRate = 0; \n\n        this.uuid = uuid(); \n\n        this.filteredData = []; \n        this.filteredEnergyDecayData = [];\n\n        this.impulseResponsePlaying = false; \n\n        this.filterTest = null;\n\n        this.T15 = [];\n        this.T20 = [];\n        this.T30 = []; \n    }\n\n    calculateAcParams(){\n        if(this.filteredData.length === 0){\n            console.error(\"No IR Data Loaded\");\n        }\n\n        this.calculateOctavebandBackwardsIntegration();\n\n        for(let f = 0; f<filterFreqs.length; f++){\n            this.T15[f] = calculateRTFromDecay(this.filteredEnergyDecayData[f],15,this.broadbandIRSampleRate);\n            this.T20[f] = calculateRTFromDecay(this.filteredEnergyDecayData[f],20,this.broadbandIRSampleRate);\n            this.T30[f] = calculateRTFromDecay(this.filteredEnergyDecayData[f],30,this.broadbandIRSampleRate);\n        }\n\n        console.log(filterFreqs); \n        console.log(\"T15 Values: \");\n        console.log(this.T15); \n        console.log(\"T20 Values: \");\n        console.log(this.T20); \n        console.log(\"T30 Values: \");\n        console.log(this.T30); \n\n    }\n\n    calculateOctavebandBackwardsIntegration(){\n        for(let f = 0; f<filterFreqs.length; f++){\n            this.filteredEnergyDecayData[f] = schroederBackwardsIntegration(this.filteredData[f]); \n        }\n    }\n\n    downloadResultsAsCSV(){\n\n        let precision = 4;\n        let freqlabel = \"Octave Band (Hz),\"\n        let t15label = \"T15,\";\n        let t20label = \"T20,\"; \n        let t30label = \"T30,\"; \n    \n        let CSV = [freqlabel.concat((filterFreqs).toString()),\n          t15label.concat((this.T15).map((n)=>n.toFixed(precision)).toString()),\n          t20label.concat((this.T20).map((n)=>n.toFixed(precision)).toString()),\n          t30label.concat((this.T30).map((n)=>n.toFixed(precision)).toString()),\n        ].join('\\n');\n    \n        var csvFile = new Blob([CSV], {type: 'text/csv'});\n        FileSaver.saveAs(csvFile, `energy-decay-${this.uuid}.csv`);\n      }\n\n    play(source: AudioBufferSourceNode){\n        if (audioEngine.context.state === 'suspended') {\n            audioEngine.context.resume();\n          }\n\n        source.connect(audioEngine.context.destination); \n        source.start();\n\n        emit(\"ENERGYDECAY_SET_PROPERTY\", { uuid: this.uuid, property: \"impulseResponsePlaying\", value: true });\n        source.onended = () => {\n            source.stop();\n            source.disconnect(audioEngine.context.destination);\n            emit(\"ENERGYDECAY_SET_PROPERTY\", { uuid: this.uuid, property: \"impulseResponsePlaying\", value: false });\n        }\n    }\n\n    set broadbandIR(f: ArrayBuffer){\n        let self = this; \n        audioEngine.context.decodeAudioData(f, async function(buffer) {\n\n            let decodeddata = trimIR(buffer.getChannelData(0)); \n\n            self.broadbandIRSource = audioEngine.createBufferSource(decodeddata);\n            self.broadbandIRData = decodeddata;\n            self.broadbandIRSampleRate = buffer.sampleRate; \n\n            self.filterTest = audioEngine.createFilteredSource(decodeddata,8000,1.414,1); \n\n            let broadbandarray: Float32Array[] = []; \n            for(let f = 0; f<filterFreqs.length; f++){\n                broadbandarray[f] = decodeddata; \n            }\n\n            for(let f = 0; f<filterFreqs.length; f++){\n                const offlineContext = audioEngine.createOfflineContext(1, decodeddata.length, buffer.sampleRate);\n                const filteredsource = audioEngine.createFilteredSource(decodeddata, filterFreqs[f], 1.414,1,offlineContext);\n                filteredsource.gain.connect(offlineContext.destination);\n                filteredsource.source.start(); \n\n                let data = await audioEngine.renderContextAsync(offlineContext);\n                self.filteredData.push(data.getChannelData(0)); \n            }\n\n        }) \n    }\n}\n\nfunction calculateRTFromDecay(decay: Float32Array,decayLength: number,sampleRate:number): number{\n    const n1: number = -5; // start at -5 dB \n    const n2: number = n1-decayLength; // ex. if T30, -5 to -35 dB \n\n    let n1_idx = indexOfMin(abs(subFromArray(decay,n1))); \n    let n2_idx = indexOfMin(abs(subFromArray(decay,n2))); \n\n    let numSamples = Math.abs(n2_idx-n1_idx); \n\n    let decay_time = numSamples/sampleRate; \n    let reverb_time = decay_time*(60/decayLength); \n\n    return reverb_time; \n}\n\nfunction indexOfMin(data: Float32Array): number{\n    let min_index = 0;\n    let min = data[min_index]; \n\n    for(let i = 0; i<data.length; i++){\n        if (min > data[i]) {\n            min = data[i]; \n            min_index = i; \n        }\n    }\n    return min_index; \n}\n\nfunction abs(data: Float32Array): Float32Array{\n    let absarray = data.map((x)=>Math.abs(x));\n    return absarray; \n}\n\nfunction subFromArray(data: Float32Array, sub: number): Float32Array{\n    let subarray = data.map((x)=>(x-sub)); \n    return subarray; \n}\n\nexport default EnergyDecay\n\n// this allows for nice type checking with 'on' and 'emit' from messenger\ndeclare global {\n    interface EventTypes {\n      ADD_ENERGYDECAY: EnergyDecay | undefined,\n      ENERGYDECAY_SET_PROPERTY: {\n        uuid: string;\n        property: keyof EnergyDecay;\n        value: EnergyDecay[EventTypes[\"ENERGYDECAY_SET_PROPERTY\"][\"property\"]]; \n      }\n      LOAD_IR_TO_ENERGYDECAY: {\n          uuid: string;\n          f: File; \n      }\n      CALCULATE_AC_PARAMS: string; \n    }\n}\n\non(\"ADD_ENERGYDECAY\", addSolver(EnergyDecay))\non(\"ENERGYDECAY_SET_PROPERTY\", setSolverProperty); \non(\"CALCULATE_AC_PARAMS\", (uuid: string) => void (useSolver.getState().solvers[uuid] as EnergyDecay).calculateAcParams());\n\n"],"names":["sum","data","acc","v","cumsum","cumulativeSum","s","value","schroederBackwardsIntegration","data_reversed_sq","x","data_reversed_sq_cumsum","data_sq","data_sq_sum","trimIR","ir","startSample","endSample","sindex","defaults","filterFreqs","EnergyDecay","Solver","props","uuid","f","calculateRTFromDecay","precision","CSV","n","csvFile","FileSaver","source","audioEngine","emit","self","buffer","decodeddata","offlineContext","filteredsource","decay","decayLength","sampleRate","n2","n1_idx","indexOfMin","abs","subFromArray","n2_idx","min_index","min","i","sub","on","addSolver","setSolverProperty","useSolver"],"mappings":"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"}